import sys
from pprint import pprint
import pandas as pd
from tabulate import tabulate
from jugaad_data.nse import NSELive
import getopt

def get_args():
	input = {}
	input['output']  = "fancy_grid"

	helpmsg = """
	Usage: stifo <input_file> -o <output_type>
	Note: <input_file> is mandatory.
	      <output_type> is optional.
	"""

	if sys.argv[1] == "--help" or sys.argv[1] == "-h":
		print(helpmsg)
		sys.exit()
	else:
		input['file'] = sys.argv[1]

	argv = sys.argv[2:]

	opts, args = getopt.getopt(argv, "ho:", ["help=", "output="])

	for opt, arg in opts:
		if opt in ['-o', '--output']:
			input['output'] = arg
			
	return input

def get_data(File):
	raw_data = pd.read_csv(File, index_col=0).to_dict("index")

	# for val in raw_data.values():
	# 	for v in val.values():
	# 		print(round(v,2))

	if raw_data == {}:
		print("ERROR: \nPlease provide some ticker values along with BP and SP")
		sys.exit(1)

	for val in raw_data.values():
		try:
			bp = val['bp']
			sp = val['sp']
		except KeyError:
			print("ERROR: \nPlease provide BP and SP")
			sys.exit(1)

		if bp > sp:
			print("ERROR: \nYou will get wrong info. \nPlease make sure that SP is greater than BP in data.csv!! \nExiting..")
			sys.exit(1)
		
	return raw_data # Returns symbols, Buy Price, Sell Price

def get_cp(ticker_data):
	for ticker in ticker_data.keys():
		n = NSELive() 
		quote = n.stock_quote(ticker) # Gets the price
		data = (quote['priceInfo']) 
		cp_temp = data["lastPrice"] # Gets the actual Current Price
		ticker_data[ticker]['cp'] = cp_temp
	return ticker_data

def compare(ticker_data):
	"""
	if cp < bp:
		final.append("buy")
	elif cp > sp:
		final.append("sell")
	"""
	for ticker in ticker_data:
		if ticker_data[ticker]['cp'] < ticker_data[ticker]['bp']:
			ticker_data[ticker]['status'] = 'buy'
		elif ticker_data[ticker]['cp'] >= ticker_data[ticker]['sp']:
			ticker_data[ticker]['status'] = 'sell'
		else:
			ticker_data[ticker]['status'] = 'keep'
	return ticker_data

def round_off(data):
	for key, val in data.items():
		for k, v in val.items():
			rounded = round(v,2)
			data[key][k] = rounded
	return data

input = get_args()

ticker_data = get_data(input['file'])
ticker_data = get_cp(ticker_data) # Gets cp

final1 = round_off(ticker_data)
final1 = compare(final1)

if input['output'] == "csv":
	final = pd.DataFrame.from_dict(final1, orient='index')
	final = final.to_csv().split('\n',1)[-1]
else:
	final = pd.DataFrame.from_dict(final1, orient='index')
	col = "status"
	first_col = final.pop(col)
	final.insert(0, col, first_col)

	headers = ['Status', 'BP', 'SP', 'CP']
	final = tabulate(final, headers, tablefmt="fancy_grid")

print(final)
